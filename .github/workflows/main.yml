name: TEST – Rotating Content Pool (DRY RUN)

on:
  workflow_dispatch:

jobs:
  test-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc wget

      # ===============================
      # AUTO-DETECT DOWNLOAD
      # ===============================
      - name: Download videos (auto-detect)
        run: |
          wget -q -r -np -nd -A "listA_*.mp4" \
            https://github.com/whateverliveyt/whatever/releases/download/v1.0/ || true
          wget -q -r -np -nd -A "listB_*.mp4" \
            https://github.com/whateverliveyt/whatever/releases/download/v1.0/ || true
          wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 || true

      # ===============================
      # INIT STATE
      # ===============================
      - name: Init state
        run: |
          ls listA_*.mp4 > active.txt
          ls listB_*.mp4 > reserve.txt
          : > recycle.txt

          echo "ACTIVE:"
          cat active.txt
          echo "RESERVE:"
          cat reserve.txt

      # ===============================
      # DRY STREAM TEST
      # ===============================
      - name: Dry run streaming (NO YOUTUBE)
        run: |
          COUNT=$(wc -l < active.txt)

          if [ "$COUNT" -ge 15 ]; then
            MAX_LOOP=1
          elif [ "$COUNT" -ge 8 ]; then
            MAX_LOOP=2
          else
            MAX_LOOP=3
          fi

          echo "Video count: $COUNT"
          echo "Max loop   : $MAX_LOOP"

          GAIN=$(awk 'BEGIN{srand(); print int(rand()*5)-2}')
          BRIGHT=$(awk 'BEGIN{srand(); printf "%.3f", (rand()*0.02 - 0.01)}')
          SAT=$(awk 'BEGIN{srand(); printf "%.3f", 1 + (rand()*0.02 - 0.01)}')

          LOOP=1
          while [ $LOOP -le $MAX_LOOP ]; do
            echo "===== DRY PLAY LOOP $LOOP ====="

            shuf active.txt > play_order.txt
            : > playlist.txt

            if [ -f intro.mp4 ] && [ $LOOP -eq 1 ]; then
              echo "file '$PWD/intro.mp4'" >> playlist.txt
            fi

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < play_order.txt

            echo "--- PLAYLIST LOOP $LOOP ---"
            cat playlist.txt

            ffmpeg -re -f concat -safe 0 -i playlist.txt \
              -filter:a "volume=${GAIN}dB" \
              -filter:v "eq=brightness=${BRIGHT}:saturation=${SAT}" \
              -t 20 \
              -f null -

            LOOP=$((LOOP+1))
          done

      # ===============================
      # ROTATION TEST
      # ===============================
      - name: Rotation test (adaptive)
        run: |
          COUNT=$(wc -l < active.txt)

          if [ "$COUNT" -ge 12 ]; then
            N=2
          else
            N=1
          fi

          echo "Rotation mode: $N OUT / $N IN"

          OUTS=$(shuf active.txt | head -n $N)
          INS=$(shuf reserve.txt | head -n $N)

          echo "OUT:"
          echo "$OUTS"
          echo "IN:"
          echo "$INS"

      - name: Test completed
        run: echo "DRY RUN SUCCESS – SCRIPT LOGIC OK"
