name: TEST – Rotating Content Pool (Dry Run)

on:
  workflow_dispatch:

jobs:
  test-rotation:
    runs-on: ubuntu-latest
    timeout-minutes: 10   # pendek, hanya untuk test

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download videos (tolerant)
        run: |
          for i in {01..20}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listA_$i.mp4 \
            || echo "listA_$i missing"
          done

          for i in {01..15}; do
            wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/listB_$i.mp4 \
            || echo "listB_$i missing"
          done

          wget https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 \
          || echo "intro missing"

      - name: Init state files
        run: |
          ls listA_*.mp4 > active.txt
          ls listB_*.mp4 > reserve.txt
          : > recycle.txt

          echo "=== ACTIVE INIT ==="
          cat active.txt
          echo "=== RESERVE INIT ==="
          cat reserve.txt

      - name: Dry Run Play (Soft Loop max 2x)
        run: |
          GAIN=$(awk 'BEGIN{srand(); print int(rand()*5)-2}')
          echo "Audio gain: ${GAIN}dB"

          LOOP=1
          MAX_LOOP=2

          while [ $LOOP -le $MAX_LOOP ]; do
            echo ""
            echo "===== DRY PLAY LOOP $LOOP ====="

            shuf active.txt > play_order.txt
            : > playlist.txt

            if [ -f intro.mp4 ] && [ $LOOP -eq 1 ]; then
              echo "file '$PWD/intro.mp4'" >> playlist.txt
            fi

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < play_order.txt

            echo "--- PLAYLIST LOOP $LOOP ---"
            cat playlist.txt

            ffmpeg -re -f concat -safe 0 -i playlist.txt \
              -filter:a "volume=${GAIN}dB" \
              -c:v libx264 -preset veryfast \
              -c:a aac \
              -f null -

            LOOP=$((LOOP+1))
          done

      - name: Rotate AFTER dry run (1 out / 1 in)
        run: |
          OUT=$(shuf active.txt | head -n 1)
          IN=$(shuf reserve.txt | head -n 1)

          echo ""
          echo "ROTATE OUT: $OUT"
          echo "ROTATE IN : $IN"

          grep -v "^$OUT$" active.txt > tmp && mv tmp active.txt
          echo "$OUT" >> recycle.txt

          grep -v "^$IN$" reserve.txt > tmp && mv tmp reserve.txt
          echo "$IN" >> active.txt

          if [ ! -s reserve.txt ]; then
            echo "Reserve empty → refill from recycle"
            cat recycle.txt > reserve.txt
            : > recycle.txt
          fi

          echo ""
          echo "=== ACTIVE (NEXT LIVE) ==="
          cat active.txt
          echo "=== RESERVE (NEXT LIVE) ==="
          cat reserve.txt
